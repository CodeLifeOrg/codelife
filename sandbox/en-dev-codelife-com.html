<html>
<head>
  <style>
    html, body {
      margin: 0;
      height: 100vh;
      padding: 0;
      width: 100%;
    }
    iframe {
      border: 0;
      height: 100vh;
      overflow: auto; 
      width: 100%;
    }
  </style>
  <script src="./scripts/loop-protect.js"></script>
  <script>
    var host = "https://en.dev.codelife.com";

    loopProtect.alias = 'protect';

    window.loopProtect = loopProtect;

    var source = null;
    
    loopProtect.hit = function (line) {
      if (source) source.postMessage(["catch", "Potential Infinite Loop found on line " + line], host);
    }

    function isNode(o) {
      return (
        typeof Node === "object" ? o instanceof Node : 
        o && typeof o === "object" && typeof o.nodeType === "number" && typeof o.nodeName==="string"
      );
    }

    function isElement(o){
      return (
        typeof HTMLElement === "object" ? o instanceof HTMLElement : //DOM2
        o && typeof o === "object" && o !== null && o.nodeType === 1 && typeof o.nodeName==="string"
      );
    }

    window.addEventListener("message", receiveMessage, false);

    window.myPost = function() {
      const payload = [];
      for (const a of arguments) {
        if (a & a.message) {
          isNode(a.message) || isElement(a.message) ? payload.push(String(a.message)) : payload.push(a.message);
        }
        else {
          isNode(a) || isElement(a) ? payload.push(String(a)) : payload.push(a)
        }
      }
      source.postMessage(payload, host);
    }

    function receiveMessage(event) {
      if (event.origin !== host) return;

      source = event.source;

      if (event.data === "wakeup") {
        source.postMessage("awake", host); 
      } 
      else {
        var win = document.getElementById('if').contentWindow;
        var doc = win.document;
        
        win.protect = loopProtect;

        doc.open();
        doc.write(event.data);

        doc.close();
      }
      
    }
  </script>

</head>
<body>

<iframe frameBorder="0" className="if" id="if" />

</body>

</html>
